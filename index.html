<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Tomato Browser</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #000000;
      --surface: #0a0a0a;
      --surface-2: #141414;
      --border: #1e1e1e;
      --border-focus: #6CABDD;
      --text: #e0e0e0;
      --text-dim: #666666;
      --text-dark: #3a3a3a;
      --accent: #6CABDD;
      --accent-soft: rgba(108, 171, 221, 0.1);
      --toolbar-h: 48px;
      --tabs-h: 38px;
    }
    html, body { height: 100%; overflow: hidden; background: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; }
    .app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }

    /* ── Tabs ── */
    .tabs-bar { display: flex; align-items: center; height: var(--tabs-h); padding: 4px 8px 0; gap: 2px; background: var(--bg); overflow-x: auto; scrollbar-width: none; flex-shrink: 0; }
    .tabs-bar::-webkit-scrollbar { display: none; }
    .tab {
      display: flex; align-items: center; gap: 6px; height: 30px; padding: 0 10px;
      background: transparent; border: none; border-radius: 8px 8px 0 0;
      color: var(--text-dim); font-family: 'Outfit', sans-serif; font-size: 12px; font-weight: 500;
      cursor: pointer; white-space: nowrap; max-width: 160px; min-width: 60px;
      transition: all 0.12s; flex-shrink: 0; position: relative;
    }
    .tab:hover { background: var(--surface); color: var(--text); }
    .tab.active { background: var(--surface); color: var(--text); }
    .tab.active::after { content: ''; position: absolute; bottom: 0; left: 8px; right: 8px; height: 2px; background: var(--accent); border-radius: 2px 2px 0 0; }
    .tab .tab-title { overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
    .tab .tab-close { width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 10px; opacity: 0; transition: all 0.1s; flex-shrink: 0; }
    .tab:hover .tab-close { opacity: 0.5; }
    .tab .tab-close:hover { opacity: 1; background: rgba(255,255,255,0.08); }
    .tab-new { width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; color: var(--text-dark); border-radius: 6px; cursor: pointer; flex-shrink: 0; transition: all 0.12s; font-size: 16px; }
    .tab-new:hover { background: var(--surface); color: var(--text-dim); }

    /* ── Toolbar ── */
    .toolbar { display: flex; align-items: center; gap: 4px; height: var(--toolbar-h); padding: 0 8px; background: var(--surface); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .nav-btn { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; color: var(--text-dim); border-radius: 6px; cursor: pointer; transition: all 0.12s; flex-shrink: 0; }
    .nav-btn:hover { background: var(--surface-2); color: var(--text); }
    .nav-btn:active { transform: scale(0.9); }
    .nav-btn:disabled { opacity: 0.2; pointer-events: none; }
    .nav-btn svg { width: 16px; height: 16px; stroke-width: 2; }

    /* ── URL Bar ── */
    .url-bar-wrap { flex: 1; display: flex; align-items: center; height: 32px; background: var(--bg); border: 1.5px solid var(--border); border-radius: 8px; padding: 0 10px; gap: 7px; margin: 0 2px; transition: border-color 0.2s, box-shadow 0.2s; }
    .url-bar-wrap:focus-within { border-color: var(--border-focus); box-shadow: 0 0 0 3px var(--accent-soft); }
    .secure-badge { display: flex; align-items: center; font-size: 11px; font-weight: 500; color: var(--accent); flex-shrink: 0; opacity: 0; transition: opacity 0.2s; }
    .secure-badge.visible { opacity: 1; }
    .secure-badge svg { width: 12px; height: 12px; }
    #urlInput { flex: 1; background: none; border: none; outline: none; color: var(--text); font-family: 'IBM Plex Mono', monospace; font-size: 12.5px; min-width: 0; }
    #urlInput::placeholder { color: var(--text-dark); }
    #urlInput::selection { background: var(--accent); color: #000; }
    .proxy-badge { font-size: 9px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; color: var(--accent); background: var(--accent-soft); padding: 2px 6px; border-radius: 4px; flex-shrink: 0; }

    /* ── Content ── */
    .browser-content { position: relative; flex: 1; background: #fff; overflow: hidden; }
    .browser-content iframe { width: 100%; height: 100%; border: none; display: block; background: #fff; }

    /* ── Loading ── */
    .loading-bar { position: absolute; top: 0; left: 0; height: 2px; background: var(--accent); width: 0; z-index: 20; border-radius: 0 2px 2px 0; pointer-events: none; }
    .loading-bar.loading { width: 80%; transition: width 12s cubic-bezier(0.08, 0.5, 0.15, 1); }
    .loading-bar.done { width: 100%; transition: width 0.15s; animation: fadeOut 0.4s 0.2s forwards; }
    @keyframes fadeOut { to { opacity: 0; } }

    /* ── Start Page ── */
    .start-page { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg); z-index: 5; gap: 28px; padding: 20px; }
    .start-page.hidden { display: none; }
    .start-title { font-size: 20px; font-weight: 600; letter-spacing: -0.3px; color: var(--accent); animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both; }
    @keyframes fadeUp { from { transform: translateY(8px); opacity: 0; } }
    .start-search { display: flex; align-items: center; width: min(480px, 90%); height: 44px; background: var(--surface); border: 1.5px solid var(--border); border-radius: 22px; padding: 0 16px; gap: 10px; transition: border-color 0.2s, box-shadow 0.2s; animation: fadeUp 0.5s 0.1s cubic-bezier(0.16, 1, 0.3, 1) both; }
    .start-search:focus-within { border-color: var(--border-focus); box-shadow: 0 0 0 4px var(--accent-soft); }
    .start-search svg { width: 15px; height: 15px; color: var(--text-dark); flex-shrink: 0; }
    #startSearchInput { flex: 1; background: none; border: none; outline: none; color: var(--text); font-family: 'Outfit', sans-serif; font-size: 14px; }
    #startSearchInput::placeholder { color: var(--text-dark); }

    /* ── Overlays ── */
    .overlay-msg { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: var(--bg); gap: 12px; z-index: 6; padding: 24px; text-align: center; }
    .overlay-msg.visible { display: flex; }
    .overlay-msg .ov-icon { font-size: 36px; margin-bottom: 4px; }
    .overlay-msg h2 { font-size: 18px; font-weight: 600; }
    .overlay-msg p { color: var(--text-dim); font-size: 13px; max-width: 380px; line-height: 1.6; }
    .overlay-msg button { margin-top: 4px; padding: 9px 22px; background: var(--accent); color: #000; border: none; border-radius: 8px; font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.12s; }
    .overlay-msg button:hover { opacity: 0.85; }
    .overlay-msg .btn-secondary { background: var(--surface-2); color: var(--text-dim); }
    .overlay-msg .btn-row { display: flex; gap: 8px; }

    .toast { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%) translateY(60px); background: var(--surface-2); border: 1px solid var(--border); color: var(--text-dim); font-size: 12px; font-weight: 500; padding: 8px 16px; border-radius: 8px; z-index: 30; pointer-events: none; transition: transform 0.3s cubic-bezier(0.16,1,0.3,1), opacity 0.3s; opacity: 0; white-space: nowrap; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    @media (max-width: 600px) {
      .toolbar { padding: 0 4px; gap: 2px; }
      .proxy-badge { display: none; }
      #urlInput { font-size: 11.5px; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="tabs-bar">
    <div id="tabsContainer" style="display:contents;"></div>
    <button class="tab-new" onclick="createNewTab()" title="New tab (Ctrl+T)">+</button>
  </div>

  <div class="toolbar">
    <button class="nav-btn" id="btnBack" onclick="goBack()" title="Back" disabled>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="15 18 9 12 15 6"/></svg>
    </button>
    <button class="nav-btn" id="btnForward" onclick="goForward()" title="Forward" disabled>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
    <button class="nav-btn" id="btnRefresh" onclick="reloadPage()" title="Reload">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
    </button>
    <button class="nav-btn" onclick="goHome()" title="Home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12l9-9 9 9"/><path d="M5 10v10a1 1 0 001 1h3v-6h6v6h3a1 1 0 001-1V10"/></svg>
    </button>
    <div class="url-bar-wrap">
      <span class="secure-badge" id="secureBadge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      </span>
      <input type="text" id="urlInput" placeholder="Search Google or enter URL" autocomplete="off" spellcheck="false">
      <span class="proxy-badge" id="proxyBadge" style="display:none;">ISOLATED</span>
    </div>
  </div>

  <div class="browser-content">
    <div class="loading-bar" id="loadingBar"></div>

    <div class="start-page" id="startPage">
      <div class="start-title">Tomato</div>
      <div class="start-search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" id="startSearchInput" placeholder="Search Google or type a URL" autofocus>
      </div>
    </div>

    <div class="overlay-msg" id="errorOverlay">
      <div class="ov-icon">⚠️</div>
      <h2 id="errorTitle">Couldn't load page</h2>
      <p id="errorDesc">The proxy couldn't fetch this site.</p>
      <div class="btn-row">
        <button class="btn-secondary" onclick="openExternal()">Open externally</button>
        <button onclick="reloadPage()">Retry</button>
      </div>
    </div>

    <iframe id="contentFrame" style="display:none;"></iframe>
    <div class="toast" id="toast"></div>
  </div>
</div>

<script>
const PROXIES = [
  u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
];
let proxyIdx = 0;
const SEARCH_URL = 'https://www.google.com/search?q=';
const HOME_URL = 'https://www.google.com';

let tabs = [], activeTabId = null, tabCounter = 0, fetchCtrl = null;

const $ = id => document.getElementById(id);
const frame = $('contentFrame'), urlInput = $('urlInput'), startPage = $('startPage');
const startSearchInput = $('startSearchInput'), errorOverlay = $('errorOverlay');
const loadingBar = $('loadingBar'), tabsContainer = $('tabsContainer');
const secureBadge = $('secureBadge'), proxyBadge = $('proxyBadge'), toast = $('toast');

function makeTab(url) {
  return { id: ++tabCounter, url: url||'', title: 'New Tab', hist: [], hi: -1, isStart: !url };
}
function createNewTab(url) {
  tabs.push(makeTab(url));
  switchToTab(tabCounter);
  if (url) navigate(url); else setTimeout(() => startSearchInput.focus(), 50);
  renderTabs();
}
function closeTab(id, e) {
  if (e) { e.stopPropagation(); e.preventDefault(); }
  if (tabs.length === 1) { Object.assign(tabs[0], { url:'', title:'New Tab', hist:[], hi:-1, isStart:true }); showStart(); renderTabs(); return; }
  const i = tabs.findIndex(t => t.id === id);
  tabs.splice(i, 1);
  if (activeTabId === id) switchToTab(tabs[Math.min(i, tabs.length-1)].id);
  renderTabs();
}
function switchToTab(id) {
  activeTabId = id;
  const t = aTab();
  if (t.isStart) { showStart(); urlInput.value = ''; proxyBadge.style.display = 'none'; secureBadge.classList.remove('visible'); }
  else { hideStart(); if (t.url) loadProxy(t.url, true); urlInput.value = clean(t.url); }
  updateNav(); renderTabs();
}
function aTab() { return tabs.find(t => t.id === activeTabId); }
function renderTabs() {
  tabsContainer.innerHTML = '';
  tabs.forEach(t => {
    const el = document.createElement('button');
    el.className = 'tab' + (t.id === activeTabId ? ' active' : '');
    el.onclick = () => switchToTab(t.id);
    el.innerHTML = `<span class="tab-title">${esc(t.title||'New Tab')}</span><span class="tab-close" onclick="closeTab(${t.id},event)">✕</span>`;
    tabsContainer.appendChild(el);
  });
}

function navigate(raw) {
  const url = normalize(raw);
  const t = aTab();
  if (t.hi < t.hist.length - 1) t.hist = t.hist.slice(0, t.hi + 1);
  t.hist.push(url); t.hi = t.hist.length - 1;
  t.url = url; t.isStart = false; t.title = host(url);
  hideStart(); errorOverlay.classList.remove('visible');
  urlInput.value = clean(url); updateNav(); renderTabs();
  loadProxy(url, false);
}
function normalize(s) {
  s = (s||'').trim();
  if (!s) return HOME_URL;
  if (/^https?:\/\//i.test(s)) return s;
  if (/^[a-zA-Z0-9]([a-zA-Z0-9-]*\.)+[a-zA-Z]{2,}/.test(s)) return 'https://' + s;
  return SEARCH_URL + encodeURIComponent(s);
}
function goBack() { const t=aTab(); if(!t||t.hi<=0)return; t.hi--; t.url=t.hist[t.hi]; t.title=host(t.url); urlInput.value=clean(t.url); updateNav(); renderTabs(); loadProxy(t.url,false); }
function goForward() { const t=aTab(); if(!t||t.hi>=t.hist.length-1)return; t.hi++; t.url=t.hist[t.hi]; t.title=host(t.url); urlInput.value=clean(t.url); updateNav(); renderTabs(); loadProxy(t.url,false); }
function reloadPage() { const t=aTab(); if(t&&t.url) loadProxy(t.url,false); }
function goHome() { const t=aTab(); t.isStart=true; t.title='New Tab'; showStart(); frame.style.display='none'; frame.removeAttribute('srcdoc'); urlInput.value=''; proxyBadge.style.display='none'; secureBadge.classList.remove('visible'); renderTabs(); setTimeout(()=>startSearchInput.focus(),50); }
function openExternal() { const t=aTab(); if(t&&t.url) window.open(t.url,'_blank'); }
function updateNav() { const t=aTab(); $('btnBack').disabled=!t||t.hi<=0; $('btnForward').disabled=!t||t.hi>=t.hist.length-1; }

async function loadProxy(url, silent) {
  if (fetchCtrl) fetchCtrl.abort();
  fetchCtrl = new AbortController();
  if (!silent) showLoading();
  errorOverlay.classList.remove('visible');

  let html = null, lastErr = null;
  for (let i = 0; i < PROXIES.length; i++) {
    const pi = (proxyIdx + i) % PROXIES.length;
    try {
      const r = await fetch(PROXIES[pi](url), { signal: fetchCtrl.signal });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const ct = r.headers.get('content-type') || '';
      if (ct && !ct.includes('html') && !ct.includes('text')) {
        hideLoading(); window.open(url, '_blank'); showToast('Opened in new window (non-HTML)'); return;
      }
      html = await r.text(); proxyIdx = pi; break;
    } catch(e) { lastErr = e; if (e.name === 'AbortError') return; }
  }

  if (!html) {
    hideLoading();
    $('errorTitle').textContent = "Couldn't load page";
    $('errorDesc').textContent = (lastErr?.message || 'All proxies failed') + '. Try opening externally.';
    errorOverlay.classList.add('visible');
    return;
  }

  injectContent(url, html);
  hideLoading();
  secureBadge.classList.toggle('visible', url.startsWith('https'));
  proxyBadge.style.display = '';
}

function injectContent(origUrl, html) {
  const baseHref = getBase(origUrl);
  const origin = getOrigin(origUrl);

  const script = `<script>
(function(){
  function rt(){var t=document.title||'';parent.postMessage({_t:1,type:'title',title:t},'*');}
  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',rt);else setTimeout(rt,80);
  new MutationObserver(rt).observe(document.querySelector('head')||document.documentElement,{subtree:true,childList:true});

  document.addEventListener('click',function(e){
    var a=e.target.closest('a');if(!a)return;
    var h=a.getAttribute('href');if(!h)return;
    if(/^(javascript:|mailto:|tel:|#|blob:|data:)/.test(h))return;
    e.preventDefault();e.stopPropagation();
    // Resolve relative URLs
    var abs=h;
    if(h.startsWith('//')){abs='https:'+h;}
    else if(h.startsWith('/')){abs='${origin}'+h;}
    else if(!/^https?:\\/\\//.test(h)){abs='${baseHref}'+h;}
    parent.postMessage({_t:1,type:'nav',url:abs},'*');
  },true);

  document.addEventListener('submit',function(e){
    var f=e.target;if(!f||f.tagName!=='FORM')return;
    e.preventDefault();
    var fd=new FormData(f);
    var p=new URLSearchParams(fd).toString();
    var action=f.action||'${origUrl}';
    // Resolve action URL
    if(action.startsWith('/')){action='${origin}'+action;}
    else if(!/^https?:\\/\\//.test(action)){action='${baseHref}'+action;}
    var url=action+(action.indexOf('?')>-1?'&':'?')+p;
    parent.postMessage({_t:1,type:'nav',url:url},'*');
  },true);

  var oo=window.open;window.open=function(u){if(u){try{u=new URL(u,'${baseHref}').href;}catch(e){}parent.postMessage({_t:1,type:'nav',url:u},'*');}};
})();
<\\/script>`;

  const baseTag = `<base href="${escA(baseHref)}">`;
  let p = html;

  // Remove existing base tags
  p = p.replace(/<base[^>]*>/gi, '');

  if (/<head[^>]*>/i.test(p)) p = p.replace(/<head([^>]*)>/i, `<head$1>${baseTag}`);
  else if (/<html[^>]*>/i.test(p)) p = p.replace(/<html([^>]*)>/i, `<html$1><head>${baseTag}</head>`);
  else p = baseTag + p;

  if (/<\/body>/i.test(p)) p = p.replace(/<\/body>/i, script + '</body>');
  else p += script;

  frame.removeAttribute('src');
  frame.setAttribute('sandbox', 'allow-scripts allow-forms allow-popups allow-modals');
  frame.srcdoc = p;
  frame.style.display = 'block';
}

window.addEventListener('message', e => {
  if (!e.data || !e.data._t) return;
  const t = aTab(); if (!t) return;
  if (e.data.type === 'nav') {
    let u = e.data.url;
    try { u = new URL(u, t.url).href; } catch {}
    navigate(u);
  } else if (e.data.type === 'title' && e.data.title) {
    t.title = e.data.title.substring(0, 60);
    renderTabs();
  }
});

function showStart() { startPage.classList.remove('hidden'); errorOverlay.classList.remove('visible'); frame.style.display='none'; }
function hideStart() { startPage.classList.add('hidden'); }
function showLoading() { loadingBar.className='loading-bar'; void loadingBar.offsetWidth; loadingBar.classList.add('loading'); }
function hideLoading() { loadingBar.classList.remove('loading'); loadingBar.classList.add('done'); }
function showToast(m) { toast.textContent=m; toast.classList.add('show'); clearTimeout(toast._i); toast._i=setTimeout(()=>toast.classList.remove('show'),2500); }
function clean(u) { return (u||'').replace(/^https?:\/\//,'').replace(/\/$/,''); }
function host(u) { try{return new URL(u).hostname.replace('www.','');}catch{return u;} }
function getBase(u) { try{const x=new URL(u);return x.origin+x.pathname.replace(/\/[^/]*$/,'/');}catch{return u;} }
function getOrigin(u) { try{return new URL(u).origin;}catch{return '';} }
function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
function escA(s) { return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

urlInput.addEventListener('keydown', e => { if(e.key==='Enter'){navigate(urlInput.value);urlInput.blur();} });
urlInput.addEventListener('focus', () => urlInput.select());
startSearchInput.addEventListener('keydown', e => { if(e.key==='Enter'){navigate(startSearchInput.value);startSearchInput.value='';} });
document.addEventListener('keydown', e => {
  const m=e.ctrlKey||e.metaKey;
  if(m&&e.key==='l'){e.preventDefault();urlInput.focus();}
  if(m&&e.key==='t'){e.preventDefault();createNewTab();}
  if(m&&e.key==='w'){e.preventDefault();closeTab(activeTabId);}
  if(m&&e.key==='r'){e.preventDefault();reloadPage();}
  if(e.altKey&&e.key==='ArrowLeft'){e.preventDefault();goBack();}
  if(e.altKey&&e.key==='ArrowRight'){e.preventDefault();goForward();}
});

// ── Service Worker (auto-updates) ──
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(reg => {
    reg.update();
    reg.addEventListener('updatefound', () => {
      const newSW = reg.installing;
      if (newSW) {
        newSW.addEventListener('statechange', () => {
          if (newSW.state === 'activated') window.location.reload();
        });
      }
    });
  }).catch(() => {});
  navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
}

createNewTab();
</script>
</body>
</html>
